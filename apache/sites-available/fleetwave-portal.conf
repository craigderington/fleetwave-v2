<VirtualHost *:443>
  ServerName portal.fleetwave.org

  SSLEngine on
  Protocols h2 http/1.1
  SSLCertificateFile /etc/letsencrypt/live/portal.fleetwave.org/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/portal.fleetwave.org/privkey.pem
  SSLOpenSSLConfCmd Curves X25519:prime256v1
  SSLUseStapling on
  SSLStaplingCache shmcb:/var/run/ocsp(128000)


  # Security headers
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "no-referrer"
  Header always set X-Frame-Options "SAMEORIGIN"
  # Compression
  AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css application/json application/javascript
  # If brotli loaded, prefer it
  <IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/plain text/html text/xml text/css application/json application/javascript
  </IfModule>
  # Timeouts
  ProxyTimeout 60
  RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
  KeepAlive On
  # Proxy common
  ProxyPreserveHost On
  ProxyRequests Off
  ProxyErrorOverride Off
  # WebSocket support (if needed later)
  RewriteEngine On
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteCond %{HTTP:Connection} upgrade [NC]
  RewriteRule ^/(.*)           ws://127.0.0.1:8080/$1 [P,L]


  # --- Option A: serve static SPA build ---
  DocumentRoot /var/www/portal
  <Directory /var/www/portal>
    Options FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>
  # SPA history fallback
  RewriteEngine On
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]

  # --- Option B: proxy to CloudFront or app (comment Option A & uncomment below) ---
  # ProxyPass        / https://dXXXXX.cloudfront.net/
  # ProxyPassReverse / https://dXXXXX.cloudfront.net/

  ErrorLog ${APACHE_LOG_DIR}/fleetwave-portal-error.log
  CustomLog ${APACHE_LOG_DIR}/fleetwave-portal-access.log combined
</VirtualHost>
